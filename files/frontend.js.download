/* global lty_frontend_params */

jQuery( function( $ ) {
    'use strict' ;
    var ticket_numbers = [ ] ;
    var LTY_Frontend = {
        init : function( ) {
            this.trigger_on_page_load( ) ;
            // Choose the ticket tab.
            $( document ).on( 'click' , '.lty-lottery-ticket-tab' , this.lottery_ticket_tab_selection ) ;
            // Select the ticket.
            $( document ).on( 'click' , '.lty-ticket' , this.lottery_ticket_selection ) ;
            // Unselect the ticket.
            $( document ).on( 'click' , '.lty-selected-ticket,.lty-processing-ticket' , this.lottery_ticket_unselection ) ;
            // Select the question answer.
            $( document ).on( 'click' , 'ul.lty-lottery-answers li' , this.select_question_answer ) ;
            // Validate the participate.
            // $( document ).on( 'click' , '.lty-participate-now-button .lty-lucky-dip-button' , this.validate_participate ) ;
            // Process the ticket lucky dip.
            $( document ).on( 'click' , '.lty-lucky-dip-button' , this.process_lucky_dip ) ;
        } , trigger_on_page_load : function( ) {
            // $( '.lty_manual_add_to_cart' ).attr( 'disabled' , true ) ;
        } , select_question_answer : function( event ) {
            event.preventDefault( ) ;
            var $this = $( event.currentTarget ) ,
                    answers_wrapper = $( $this ).closest( '.lty-lottery-answers' ) ,
                    answer_id = $( $this ).data( 'answer-id' ) ;
            answers_wrapper.find( 'li' ).removeClass( 'lty-selected' ) ;
            $( $this ).addClass( 'lty-selected' ) ;
            $( '.lty-question-answer-id' ).val( answer_id ) ;
            $( '.lty-lottery-ticket-container' ).addClass('unlock');    
            LTY_Frontend.handle_add_cart_button( ) ;
        } , handle_add_cart_button : function( ) {
            var show_button = true ,
                    ticket_container = $( '.lty-lottery-ticket-container' ) ,
                    question_container = $( '.lty-lottery-question-answer-container' ) ,
                    lucky_dip_container = $( '.lty-lottery-ticket-lucky-dip-container' ) ;
            if( ticket_container.length && '' == ticket_container.find( '.lty-lottery-ticket-numbers' ).val( ) ) {
                show_button = false ;
            }

            if( question_container.length && 'yes' == question_container.data( 'force' ) && '' == question_container.find( '.lty-question-answer-id' ).val( ) ) {
                show_button = false ;
            }

            // Show manual add to cart button.
            if( show_button ) {
                // $( '.lty_manual_add_to_cart' ).removeAttr( 'disabled' ) ;
            }

            // Show Lucky dip Button. 
            if( question_container.length && 'yes' == question_container.data( 'force' ) && '' != question_container.find( '.lty-question-answer-id' ).val( ) ) {
                if( lucky_dip_container.length ) {
                    lucky_dip_container.find( '.lty-lucky-dip-button' ).removeAttr( 'disabled' ) ;
                    lucky_dip_container.find( '.lty-lucky-dip-button' ).removeAttr( 'title' ) ;
                }
            }
        } , validate_participate : function( event ) {
            var error_message = null ;
            if( 'yes' == lty_frontend_params.guest_user ) {
                error_message = lty_frontend_params.guest_error_msg ;
            }

            if( error_message ) {
                event.preventDefault( ) ;
                alert( error_message ) ;
                return false ;
            }

            return true ;
        } , lottery_ticket_tab_selection : function( event ) {
            event.preventDefault( ) ;
            var $this = $( event.currentTarget ) ,
                    tickets_container = $( $this ).closest( '.lty-lottery-ticket-container' ) ;
            LTY_Frontend.block( tickets_container ) ;
            var data = ( {
                action : 'lty_ticket_tab_selection' ,
                product_id : tickets_container.find( '.lty-ticket-product-id' ).val( ) ,
                tab : $this.data( 'tab' ) ,
                lty_security : lty_frontend_params.lottery_tickets_nonce ,
            } ) ;
            $.post( lty_frontend_params.ajaxurl , data , function( res ) {
                if( true === res.success ) {

                    tickets_container.find( '.lty-lottery-ticket-tab' ).removeClass( 'lty-active-tab' ) ;
                    $( $this ).addClass( 'lty-active-tab' ) ;
                    tickets_container.find( '.lty-lottery-ticket-tab-content' ).html( res.data.html ) ;

                    // class 'lty-selected-ticket' added when ticket tab selection is clicked. 
                    var $selected_ticket_numbers = $( '.lty-lottery-ticket-numbers' ).val( ) ;
                    for( var i = 0 ; i < $selected_ticket_numbers.length ; i++ ) {
                        if( $.isNumeric( $selected_ticket_numbers[i] ) ) {
                            $( '.lty-ticket[data-ticket="' + $selected_ticket_numbers[i] + '"]' ).addClass( 'lty-selected-ticket' ) ;
                        }
                    }
                } else {
                    alert( res.data.error ) ;
                }

                LTY_Frontend.unblock( tickets_container ) ;
            }
            ) ;
        } , lottery_ticket_selection : function( event ) {
            event.preventDefault( ) ;
            var $this = $( event.currentTarget ) ,
                    tickets_container = $( $this ).closest( '.lty-lottery-ticket-container' ) ,
                    selected_tickets = tickets_container.find( '.lty-lottery-ticket-numbers' ) ,
                    quantity = tickets_container.find( '.lty-lottery-ticket-quantity' ) ;

            if( $this.hasClass( "lty-reserving-ticket" ) || $this.hasClass( "lty-reserved-ticket" ) || $this.hasClass( "lty-booked-ticket" ) || $this.hasClass( "lty-processing-ticket" ) || $this.hasClass( "lty-selected-ticket" ) ) {
                return ;
            }

            $( $this ).addClass( 'lty-reserving-ticket' ) ;

            $.ajaxQueue({
                queue: true,
                url: lty_frontend_params.ajaxurl,
                type: "POST",
                data: {
                    nonce: lty_frontend_params.lottery_tickets_nonce, 
                    ticket_number: $( $this ).data( 'ticket' ),
                    action: 'reserve_ticket',
                    product_id: $( $this ).data( 'product_id' ),
                    answer:$( '.lty-question-answer-id' ).val()
                }})
                .done(function(data){
                    data = JSON.parse(data);
                    $( $this ).removeClass( 'lty-reserving-ticket' ) ;
				    // jQuery(document.body).trigger('wc_fragment_refresh');
                    if(data.error) {
                        switch(data.status) {
                            case "purchased": $( $this ).addClass( 'lty-purchased-ticket' );break;
                            case "reserved": $( $this ).addClass( 'lty-processing-ticket' );break;
                            case "available": break;
                            case "blocked": $( $this ).addClass( 'lty-reserved-ticket' );break;
                        }
                        
                        showAlert("Oops!",data.message);
				// 		alert(data.message);
                    } else {
                        var cartItems = parseInt($(".cart-icon-container .badge").html()) ? parseInt($(".cart-icon-container .badge").html()) : 0;
                        $(".cart-icon-container .badge").html(cartItems+1);
                        $(".cart-icon-container .badge").show();
                        switch(data.status) {
                            case "purchased": $( $this ).addClass( 'lty-purchased-ticket' );break;
                            case "reserved": $( $this ).addClass( 'lty-processing-ticket' );break;
                            case "available": break;
                            case "blocked": $( $this ).addClass( 'lty-reserved-ticket' );break;
                        }
                        ticket_numbers.push( $( $this ).data( 'ticket' ) ) ;
                        selected_tickets.val( ticket_numbers ) ;
                        if(data.nonce) {
                            lty_frontend_params.lottery_tickets_nonce = data.nonce;    
                        }
                        quantity.val( ticket_numbers.length ) ;
                        LTY_Frontend.handle_add_cart_button( ) ;
                        // $( $this ).addClass( 'lty-selected-ticket' ) ;
                        
                    }
                });
        } , lottery_ticket_unselection : function( event ) {
            event.preventDefault( ) ;
            var $this = $( event.currentTarget ) ,
                    tickets_container = $( $this ).closest( '.lty-lottery-ticket-container' ) ,
                    selected_tickets = tickets_container.find( '.lty-lottery-ticket-numbers' ) ,
                    quantity = tickets_container.find( '.lty-lottery-ticket-quantity' ) ;

            var $ticket = $( $this ).data( 'ticket' ) ;

            
            $( $this ).addClass( 'lty-reserving-ticket' ) ;
             $.ajaxQueue({
                queue: true,
                url: lty_frontend_params.ajaxurl,
                type: "POST",
                data: {
                    nonce: lty_frontend_params.lottery_tickets_nonce, 
                    ticket_number: $( $this ).data( 'ticket' ),
                    action: 'remove_tickets_from_cart',
                    product_id: $( $this ).data( 'product_id' ),
                }})
                .done(function(data){
                    // jQuery(document.body).trigger('wc_fragment_refresh');
                    $( $this ).removeClass( 'lty-reserving-ticket' ) ;
                    $( $this ).removeClass( 'lty-selected-ticket' ) ;
                    $( $this ).removeClass( 'lty-processing-ticket' ) ;
                    ticket_numbers.splice( ticket_numbers.indexOf( $ticket ) , 1 ) ;
                    selected_tickets.val( ticket_numbers ) ;
                    quantity.val( ticket_numbers.length ) ;
                    LTY_Frontend.handle_add_cart_button() ;
                    var cartItems = parseInt($(".cart-icon-container .badge").html());
                    $(".cart-icon-container .badge").html(cartItems-1);
                    if( !ticket_numbers.length ) {
                    //   $( '.lty_manual_add_to_cart' ).attr( 'disabled' , true ) ;
                    }
                }
            );

        } , process_lucky_dip : function( event ) {
            if(event) {
                event.preventDefault();
            }
            
            var $this = $('.lty-lucky-dip-button') ,
                    tickets_container = $( $this ).closest( '.lty-lottery-ticket-container' ) ;
                    
            var currentTab = $('.lty-lottery-ticket-tab.lty-active-tab');
            LTY_Frontend.block( $this ) ;
            var data = ( {
                action : 'lty_process_lucky_dip' ,
                product_id : tickets_container.find( '.lty-ticket-product-id' ).val( ) ,
                qty : tickets_container.find( '.lty-lucky-dip-quantity' ).val( ) ,
                answer : $( '.lty-question-answer-id' ).val( ) ,
                lty_security : lty_frontend_params.lottery_tickets_nonce ,
            } ) ;
            $.post( lty_frontend_params.ajaxurl , data , function( res ) {
                if( true === res.success ) {
                    // alert( res.data.msg ) ;
                    var cartItems = parseInt($(".cart-icon-container .badge").html()) ? parseInt($(".cart-icon-container .badge").html()) : 0;
                    $(".cart-icon-container .badge").html(cartItems+parseInt(tickets_container.find( '.lty-lucky-dip-quantity' ).val( )));
                    $(".cart-icon-container .badge").show();
                    showAlert("Tickets Added!",res.data.msg,true);
                    // jQuery(document.body).trigger('wc_fragment_refresh');
                } else {
                    // alert( res.data.error ) ;
                    showAlert("Oops!",res.data.error);                
                }
                LTY_Frontend.unblock( $this ) ;
                if(currentTab) {
                    currentTab.click();
                }
            } ) ;
        } ,
        block : function( id ) {
            $( id ).block( {
                message : null ,
                overlayCSS : {
                    background : '#fff' ,
                    opacity : 0.7
                }
            } ) ;
        } , unblock : function( id ) {
            $( id ).unblock( ) ;
        } ,
    } ;
    
    LTY_Frontend.init( ) ;
    
    var ajaxQueue = $({});
    
    $.ajaxQueue = function( ajaxOpts ) {
        var jqXHR,
            dfd = $.Deferred(),
            promise = dfd.promise();
    
        // run the actual query
        function doRequest( next ) {
            jqXHR = $.ajax( ajaxOpts );
            jqXHR.done( dfd.resolve )
                .fail( dfd.reject )
                .then( next, next );
        }
    
        // queue our ajax request
        ajaxQueue.queue( doRequest );
    
        // add the abort method
        promise.abort = function( statusText ) {
    
            // proxy abort to the jqXHR if it is active
            if ( jqXHR ) {
                return jqXHR.abort( statusText );
            }
    
            // if there wasn't already a jqXHR we need to remove from queue
            var queue = ajaxQueue.queue(),
                index = $.inArray( doRequest, queue );
    
            if ( index > -1 ) {
                queue.splice( index, 1 );
            }
    
            // and then reject the deferred
            dfd.rejectWith( ajaxOpts.context || ajaxOpts, [ promise, statusText, "" ] );
            return promise;
        };
    
        return promise;
    };
} ) ;
